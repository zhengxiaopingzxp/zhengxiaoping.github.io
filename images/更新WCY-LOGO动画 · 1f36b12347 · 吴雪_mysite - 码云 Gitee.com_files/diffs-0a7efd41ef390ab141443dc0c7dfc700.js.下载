var SingleFileDiff=function(){function e(e){this.file=e,this.toggleDiff=this.toggleDiff.bind(this),this.content=$(".diff-content",this.file),this.diffForPath=this.content.find("[data-diff-for-path]").data("diff-for-path"),this.isOpen=!this.diffForPath,this.isLoading=!1,this.diffForPath?(this.collapsedContent=this.content,this.loadingContent=$(n).addClass("loading").html(r).hide(),this.content=null,this.collapsedContent.after(this.loadingContent)):(this.collapsedContent=$(n).html(a).hide(),this.content.after(this.collapsedContent)),$(".js-file-title, .click-to-expand",this.file).on("click",function(e){this.toggleDiff($(e.target))}.bind(this))}var t=window._web_tips||{},i=t.diffCollapsedTips||"点击展开",s=t.diffLoadFailedTips||"差异加载失败",n='<div class="diff-content"></div>',r='<div class="ui active inline loader"></div>',o='<div class="nothing-here-block">'+s+"</div>",a='<div class="nothing-here-block diff-collapsed"><a class="click-to-expand">'+i+"</a></div>";return e.prototype.toggleDiff=function(e,t){if((e.hasClass("js-file-title")||e.hasClass("click-to-expand"))&&!this.isLoading)if(this.isOpen=!this.isOpen,this.isOpen||this.hasError){if(!this.content)return this.isLoading=!0,this.getContentHTML(t);this.collapsedContent.hide(),this.content.show()}else this.content.hide(),this.collapsedContent.show()},e.prototype.getContentHTML=function(e){this.collapsedContent.hide(),this.loadingContent.show(),$.get(this.diffForPath,function(t){return function(i){t.isLoading=!1,t.loadingContent.hide(),i.html?t.content=$(n).html(i.html):(t.hasError=!0,t.content=$(o)),t.collapsedContent.after(t.content),e&&e()}}(this))},e}();(function(e){"function"==typeof define&&define.amd?define(["jquery"],e):"object"==typeof exports?module.exports=e(require("jquery")):e(jQuery)})(function(e){var t="waitForImages",i=function(e){return e.srcset&&e.sizes}(new Image);e.waitForImages={hasImageProperties:["backgroundImage","listStyleImage","borderImage","borderCornerImage","cursor"],hasImageAttributes:["srcset"]},e.expr[":"]["has-src"]=function(t){return e(t).is('img[src][src!=""]')},e.expr[":"].uncached=function(t){return e(t).is(":has-src")?!t.complete:!1},e.fn.waitForImages=function(){var s,n,r,o=0,a=0,l=e.Deferred(),c=this,h=[],d=e.waitForImages.hasImageProperties||[],u=e.waitForImages.hasImageAttributes||[],p=/url\(\s*(['"]?)(.*?)\1\s*\)/g;if(e.isPlainObject(arguments[0])?(r=arguments[0].waitForAll,n=arguments[0].each,s=arguments[0].finished):arguments.length===1&&e.type(arguments[0])==="boolean"?r=arguments[0]:(s=arguments[0],n=arguments[1],r=arguments[2]),s=s||e.noop,n=n||e.noop,r=!!r,!e.isFunction(s)||!e.isFunction(n))throw new TypeError("An invalid callback was supplied.");return this.each(function(){var t=e(this);r?t.find("*").addBack().each(function(){var t=e(this);t.is("img:has-src")&&!t.is("[srcset]")&&h.push({src:t.attr("src"),element:t[0]}),e.each(d,function(e,i){var s,n=t.css(i);if(!n)return!0;for(;s=p.exec(n);)h.push({src:s[2],element:t[0]})}),e.each(u,function(e,i){var s=t.attr(i);return s?(h.push({src:t.attr("src"),srcset:t.attr("srcset"),element:t[0]}),void 0):!0})}):t.find("img:has-src").each(function(){h.push({src:this.src,element:this})})}),o=h.length,a=0,0===o&&(s.call(c),l.resolveWith(c)),e.each(h,function(r,h){var d=new Image,u="load."+t+" error."+t;e(d).one(u,function p(t){var i=[a,o,t.type=="load"];return a++,n.apply(h.element,i),l.notifyWith(h.element,i),e(this).off(u,p),a==o?(s.call(c[0]),l.resolveWith(c[0]),!1):void 0}),i&&h.srcset&&(d.srcset=h.srcset,d.sizes=h.sizes),d.src=h.src}),l.promise()}});var ImageFile=function(){function e(e){this.file=e,this.requestImageInfo($(".two-up.view .frame.deleted img",this.file),function(e){return function(){return e.requestImageInfo($(".two-up.view .frame.added img",e.file),function(){e.initViewModes();var t=$(".two-up.view img",e.file);t.waitForImages(function(){e.initView("two-up")})})}}(this))}var t=900,i=["two-up","swipe"];return e.prototype.initViewModes=function(){var e=i[0];return $(".view-modes",this.file).removeClass("hide"),$(".view-modes-menu",this.file).on("click","li",function(e){return function(t){return $(t.currentTarget).hasClass("active")?void 0:e.activateViewMode(t.currentTarget.className)}}(this)),this.activateViewMode(e)},e.prototype.activateViewMode=function(e){return $(".view-modes-menu li",this.file).removeClass("active").filter("."+e).addClass("active"),$(".view:visible:not(."+e+")",this.file).fadeOut(200,function(t){return function(){return $(".view."+e,t.file).fadeIn(200).removeClass("hide"),t.initView(e)}}(this))},e.prototype.initView=function(e){return this.views[e].call(this)},e.prototype.initDraggable=function(e,t,i){var s=!1,n=$("body"),r=e.parent();e.off("mousedown").on("mousedown",function(){s=!0,n.css("user-select","none")}),n.off("mouseup").off("mousemove").on("mouseup",function(){s=!1,n.css("user-select","")}).on("mousemove",function(e){var n;s&&(n=e.pageX-(r.offset().left+t),i(e,n))})},e.prototype.prepareFrames=function(e){var t=0,i=0;return $(".frame",e).each(function(){return function(e,s){var n,r;return r=parseFloat($(s).css("width")),n=parseFloat($(s).css("height")),i=r>i?r:i,t=n>t?n:t}}(this)).css({width:i,height:t}),[i,t]},e.prototype.views={"two-up":function(){return $(".two-up.view .wrap",this.file).each(function(e){return function(i,s){return $("img",s).each(function(){var e;return e=$(this).width(),e>t/2?$(this).width(t/2):void 0}),e.requestImageInfo($("img",s),function(e,t){return $(".image-info .meta-width",s).text(e+"px"),$(".image-info .meta-height",s).text(t+"px"),$(".image-info",s).removeClass("hide")})}}(this))},swipe:function(){var e=0,t=0;return $(".swipe.view",this.file).each(function(i){return function(s,n){var r,o,a,l,c;c=i.prepareFrames(n),t=c[0],e=c[1],a=$(".swipe-frame",n),r=$(".swipe-wrap",n),o=$(".swipe-bar",n),a.css({width:t+16,height:e+28}),r.css({width:t+1,height:e+2}),o.css({left:1}),l=parseInt(r.css("right").replace("px",""),10),i.initDraggable(o,l,function(e,i){i>0&&i<a.width()-2*l&&(r.width(t+1-i),o.css("left",i))})}}(this))},"onion-skin":function(){var e=0,t=0,i=0;return e=$(".drag-track",this.file).width()-$(".dragger",this.file).width(),$(".onion-skin.view",this.file).each(function(s){return function(n,r){var o,a,l,c,h,d;d=s.prepareFrames(r),i=d[0],t=d[1],o=$(".onion-skin-frame",r),c=$(".frame.added",r),a=$(".drag-track",r),l=$(".dragger",a),o.css({width:i+16,height:t+28}),$(".swipe-wrap",r).css({width:i+1,height:t+2}),l.css({left:e}),c.css("opacity",1),h=parseInt(c.css("right").replace("px",""),10),s.initDraggable(l,h,function(t,i){var s=i/e;s>=0&&1>=s&&(l.css("left",i),c.css("opacity",s))})}}(this))}},e.prototype.requestImageInfo=function(e,t){var i=e.get(0);return i?i.complete?t.call(this,i.naturalWidth,i.naturalHeight):e.on("load",function(e){return function(){return t.call(e,i.naturalWidth,i.naturalHeight)}}(this)):void 0},e}();$(function(){var e=$(".files .diff-file");e.each(function(e,t){$.data(t,"singleFileDiff")||$.data(t,"singleFileDiff",new SingleFileDiff(t)),new ImageFile(t)})});